<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kilimolink</title>
    <link rel="icon" href="https://th.bing.com/th/id/OIP.pEPlFN84MUEabP9siU0lGwHaHM?rs=1&pid=ImgDetMain&cb=idpwebp2&o=7&rm=3" type="">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f7f7f7;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 220px;
            height: 100vh;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            padding-top: 24px;
            z-index: 1000;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 10px 20px;
            text-decoration: none;
            color: #24292f;
            font-size: 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar-link img {
            width: 24px;
            height: 24px;
            margin: 0;
        }
        .sidebar-link span {
            font-size: 16px;
            font-weight: 500;
        }
        .sidebar-link.active,
        .sidebar-link:hover {
            background: #f6f8fa;
            color: #0969da;
        }
        .sidebar-link.active img,
        .sidebar-link:hover img {
            filter: none;
        }
        .main-content {
            margin-left: 220px;
            padding: 32px 24px 80px 24px;
            max-width: 900px;
            min-height: 100vh;
        }
        .header {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            margin-bottom: 24px;
            padding: 24px;
        }
        .search-bar {
            margin-bottom: 20px;
            width: 95%;
        }
        .search-bar input {
            width: 100%;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }
        .tab {
            padding: 10px 18px;
            background: #e9ecef;
            border-radius: 8px 8px 0 0;
            text-decoration: none;
            color: #222;
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
        }
        .tab.active, .tab:hover {
            background: #68c56b;
            color: #fff;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 24px;
        }
        .product {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .product img {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
        }
        .product .name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .product .price {
            color: #555;
            margin-bottom: 8px;
        }
        .cart-btn {
            background: #68c56b;
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 8px 18px;
            text-decoration: none;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .cart-btn:hover {
            background: #57a85a;
        }
        .not-found {
            grid-column: 1 / -1;
            text-align: center;
            color: #c00;
            font-size: 1.2em;
            padding: 32px 0;
        }
        @media (max-width: 700px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                padding: 16px 4px 80px 4px;
            }
            .product-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="home.html" class="sidebar-link"><img src="https://th.bing.com/th?q=Home+Icon&w=120&h=120&c=1&rs=1&qlt=70&o=7&cb=1&pid=InlineBlock&rm=3&mkt=en-WW&cc=TZ&setlang=en&adlt=moderate&t=1&mw=247" alt=""><span>Home</span></a>
        <a href="market.html" class="sidebar-link active"><img src="https://th.bing.com/th/id/OIP.JdNXjqqetFQlgBRzx02g1gHaE8?pid=ImgDet&w=192&h=128&c=7&cb=idpwebp2&o=7&rm=3" alt=""><span>Market</span></a>
        <a href="expert.html" class="sidebar-link"><img src="https://th.bing.com/th/id/OIP.6c-EtQ8EGVJMTmxD0nSlKwHaHa?w=175&h=180&c=7&r=0&o=7&pid=1.7&rm=3" alt=""><span>Expert Service</span></a>
        <a href="discussion.html" class="sidebar-link"><img src="https://cdn-icons-png.flaticon.com/128/1500/1500455.png" alt=""><span>Community</span></a>
        <a href="profile.html" class="sidebar-link"><img src="https://cdn-icons-png.flaticon.com/128/4140/4140048.png" alt=""><span>Profile</span></a>
    </div>
    <div class="main-content">
        <!-- Header -->
        <!-- <div class="header">
            <h1>Fruits in the market</h1>
        </div> -->

        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search products...">
        </div>

        <!-- Categories -->
        <div class="tabs">
            <a href="market.html" class="tab active">Fruits</a>
            <a href="vegetables.html" class="tab">Vegetables</a>
            <a href="grains.html" class="tab">Grains</a>
            <a href="tubers.html" class="tab">Tubers</a>
            <a href="upload.html" class="tab" style="margin-left:auto; background:#28a745; color:#fff; font-weight:bold;">
                + Upload product
            </a>
        </div>

        <!-- Product Grid -->
        <div class="product-grid" id="productGrid">
            <div class="product" data-name="pineapple">
                <img src="images/pineapple.jpeg" alt="pineapple">
                <div class="name">Pineapple</div>
                <div class="price">2000 Tsh</div>
                <a href="#" class="cart-btn">Get</a>
            </div>
            <div class="product" data-name="banana">
                <img src="images/banana.jpg" alt="Banana">
                <div class="name">Banana</div>
                <div class="price">350 Tsh</div>
                <a href="#" class="cart-btn">Get</a>
            </div>
            <div class="product" data-name="mango">
                <img src="images/mango.jpeg" alt="mango">
                <div class="name">Mango</div>
                <div class="price">1000 Tsh</div>
                <a href="#" class="cart-btn">Get</a>
            </div>
            <div class="product" data-name="oranges">
                <img src="images/oranges.jpeg" alt="oranges">
                <div class="name">Oranges</div>
                <div class="price">250 Tsh</div>
                <a href="#" class="cart-btn">Get</a>
            </div>
        </div>
        <div id="notFound" class="not-found" style="display:none;">Product does not exist</div>
        <div style="height: 60px;"></div>
    </div>
    
    <script>
        const searchInput = document.getElementById('searchInput');
        const productGrid = document.getElementById('productGrid');
        const notFound = document.getElementById('notFound');
        const products = Array.from(productGrid.getElementsByClassName('product'));

        searchInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            let found = false;

            products.forEach(product => {
                const name = product.querySelector('.name').textContent.trim().toLowerCase();
                if (name.includes(query)) {
                    product.style.display = '';
                    found = true;
                } else {
                    product.style.display = 'none';
                }
            });

            // If no product is found
            if (!found && query !== '') {
                notFound.style.display = 'block';
            } else {
                notFound.style.display = 'none';
            }
        });
    </script>
    <script>
// Helper to get "time ago" string (minimum: seconds)
function timeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const seconds = Math.floor((now - date) / 1000);

    if (seconds < 60) return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
    const days = Math.floor(hours / 24);
    return `${days} day${days !== 1 ? 's' : ''} ago`;
}

// Modal for seller info
function showSellerModal(name, phone) {
    let modal = document.getElementById('sellerModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'sellerModal';
        modal.innerHTML = `
            <div class="seller-modal-content">
                <button class="seller-modal-close" onclick="document.getElementById('sellerModal').style.display='none'">&times;</button>
                <h3>Seller Information</h3>
                <div id="sellerInfo"></div>
            </div>
        `;
        document.body.appendChild(modal);
        // Add modal styles
        const style = document.createElement('style');
        style.textContent = `
#sellerModal {
    position: fixed; z-index: 3000; left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.18); display: flex; align-items: center; justify-content: center;
}
.seller-modal-content {
    background: #fff; border-radius: 12px; padding: 28px 22px 18px 22px;
    max-width: 320px; width: 90vw; box-shadow: 0 4px 16px rgba(0,0,0,0.13); position: relative;
    text-align: center;
}
.seller-modal-close {
    position: absolute; top: 8px; right: 12px; font-size: 1.3em; color: #888;
    background: none; border: none; cursor: pointer;
}
.seller-modal-content h3 {
    margin-top: 0; color: #218838;
}
.seller-modal-content .seller-label {
    font-weight: bold; color: #444; margin-right: 4px;
}
.seller-modal-content .seller-value {
    color: #0969da; font-weight: 500;
}
        `;
        document.head.appendChild(style);
    }
    document.getElementById('sellerInfo').innerHTML = `
        <div><span class="seller-label">Name:</span> <span class="seller-value">${name}</span></div>
        <div style="margin-top:8px;"><span class="seller-label">Phone:</span> <span class="seller-value">${phone}</span></div>
    `;
    modal.style.display = 'flex';
    // Close modal on outside click
    modal.onclick = function(e) {
        if (e.target === modal) modal.style.display = 'none';
    };
}

document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('productGrid');
    fetch('/api/products/fruits')
        .then(res => res.json())
        .then(data => {
            loadedProducts = data.products || [];
            if (loadedProducts.length > 0) {
                grid.innerHTML = '';
                loadedProducts.forEach(p => {
                    const timeBadge = p.created_at
                        ? `<div class="time-badge"><span>&#128337;</span> ${timeAgo(p.created_at)}</div>`
                        : '';
                    const sellerName = p.seller_name ? p.seller_name : "Unknown";
                    const sellerPhone = p.seller_phone ? p.seller_phone : "Not provided";
                    // Check if user is admin
                    const user = JSON.parse(localStorage.getItem('user'));
                    const isAdmin = user && user.role === 'admin';
                    const buttonHTML = isAdmin
                        ? `<button class="delete-btn" style="background:#c00; color:#fff; margin-top:8px;">Delete</button>`
                        : `<button class="cart-btn">Get</button>`;
                    const productHTML = `
                        <div class="product" style="position:relative;" data-id="${p.id}">
                            ${timeBadge}
                            <img src="${p.image}" alt="${p.name}">
                            <div class="name">${p.name}</div>
                            <div class="price">${p.price} Tsh</div>
                            ${buttonHTML}
                        </div>
                    `;
                    grid.insertAdjacentHTML('beforeend', productHTML);
                });
            }
        });
});

// Add styles for the time badge
const style = document.createElement('style');
style.textContent = `
.time-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(30,30,30,0.85);
    color: #fff;
    font-size: 0.98em;
    font-weight: 600;
    border-radius: 8px;
    padding: 2px 10px 2px 7px;
    display: flex;
    align-items: center;
    gap: 4px;
    z-index: 2;
}
.time-badge span {
    font-size: 1em;
    margin-right: 2px;
}
`;
document.head.appendChild(style);

// Show delete buttons if admin
const user = JSON.parse(localStorage.getItem('user'));
if (user && user.role === 'admin') {
    document.querySelectorAll('.delete-btn').forEach(btn => btn.style.display = 'block');
}

// Delete product handler
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-btn')) {
        const productDiv = e.target.closest('.product');
        const productId = productDiv.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this product?')) {
            fetch(`/api/products/${productId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.message && data.message.toLowerCase().includes('success')) {
                        productDiv.remove();
                    } else {
                        alert(data.message || 'Failed to delete product.');
                    }
                });
        }
    }
});
</script>
<script>
function showCartModal(productName, phone) {
    let modal = document.getElementById('cartModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'cartModal';
        modal.innerHTML = `
            <div class="cart-modal-content">
                <button class="cart-modal-close" onclick="document.getElementById('cartModal').style.display='none'">&times;</button>
                <h3>Seller Information</h3>
                <div id="cartInfo"></div>
            </div>
        `;
        document.body.appendChild(modal);
        // Modal styles
        const style = document.createElement('style');
        style.textContent = `
#cartModal {
    position: fixed; z-index: 3000; left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.18); display: flex; align-items: center; justify-content: center;
}
.cart-modal-content {
    background: #fff; border-radius: 12px; padding: 28px 22px 18px 22px;
    max-width: 320px; width: 90vw; box-shadow: 0 4px 16px rgba(0,0,0,0.13); position: relative;
    text-align: center;
}
.cart-modal-close {
    position: absolute; top: 8px; right: 12px; font-size: 1.3em; color: #888;
    background: none; border: none; cursor: pointer;
}
.cart-modal-content h3 {
    margin-top: 0; color: #218838;
}
.seller-label {
    font-weight: bold; color: #444; margin-right: 4px;
}
.seller-value {
    color: #0969da; font-weight: 500;
}
        `;
        document.head.appendChild(style);
    }
    document.getElementById('cartInfo').innerHTML = `
        <div><span class="seller-label">Name:</span> <span class="seller-value">${productName || 'Unknown'}</span></div>
        <div style="margin-top:8px;"><span class="seller-label">Phone:</span> <span class="seller-value">${phone || 'Not provided'}</span></div>
    `;
    modal.style.display = 'flex';
    // Close modal on outside click
    modal.onclick = function(e) {
        if (e.target === modal) modal.style.display = 'none';
    };
}

// Attach to dynamically loaded products
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('cart-btn')) {
        e.preventDefault();
        // Find product element and its id
        const productDiv = e.target.closest('.product');
        const productId = productDiv ? productDiv.getAttribute('data-id') : null;
        const product = loadedProducts.find(p => p.id == productId);
        // Show modal with product details
        showCartModal(product ? product.name : null, product ? product.seller_phone : null);
    }
});
</script>
</body>
</html>
